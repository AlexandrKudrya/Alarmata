# Sleep Guardian — Правила для AI-разработчика

Этот документ содержит обязательные правила, которым должен следовать AI (Claude Code) при работе над проектом.

---

## 1. Документация папок (index.md)

**Правило от владельца проекта:**

> В каждой папке с кодом лежит файл `index.md`, в котором описано, что лежит в каждой папке/файле этой директории и за какую логику это отвечает.

### Формат index.md

```markdown
# Название папки

Краткое описание назначения этой папки.

## Файлы

- `FileName.kt` — Описание файла и его ответственности.
- `AnotherFile.kt` — Описание.

## Подпапки

- `subfolder/` — Описание, что содержит подпапка.
```

### Когда обновлять index.md
- При создании нового файла в папке
- При удалении файла из папки
- При значительном изменении ответственности файла
- При создании новой подпапки

### Где создавать index.md
- В каждой папке внутри `app/src/main/java/com/sleepguardian/`
- В каждой подпапке с кодом
- **Не** создавать в: `build/`, `.gradle/`, `.git/`, `gradle/`

---

## 2. Архитектурные правила

### Следуй Clean Architecture
- Никогда не импортируй классы из `data/` в `features/`
- Domain-слой не зависит от Android SDK
- Зависимости направлены внутрь: features → domain ← data

### Один файл — одна ответственность
- Один класс/интерфейс на файл (за исключением sealed classes и тесно связанных data classes)
- ViewModel — только управление UI state и вызов use cases
- UseCase — только одна бизнес-операция

### Новый код — в правильное место
- Не создавай "мусорные" утилитные файлы
- Перед созданием нового файла убедись, что для него есть подходящая папка
- Если папки нет — создай и обнови index.md

---

## 3. Правила работы с кодом

### Перед написанием кода
- Прочитай описание текущей итерации в `docs/iterations/`
- Изучи существующий код, который будет затронут
- Убедись, что зависимости текущей итерации выполнены

### При написании кода
- Следуй code style из `docs/CODESTYLE.md`
- Не оставляй закомментированный код
- Не используй `!!` (force unwrap) — найди безопасную альтернативу
- Не используй `GlobalScope` — используй `viewModelScope` или структурированные coroutines
- Каждый публичный API должен обрабатывать ошибки

### После написания кода
- Обнови `index.md` в затронутых папках
- Убедись, что код компилируется
- Проверь, что существующие тесты не сломаны
- Напиши тесты для новой логики

---

## 4. Правила работы с БД (Room)

### Миграции
- Никогда не используй `fallbackToDestructiveMigration()` в production
- Каждое изменение схемы — новая миграция
- Тестируй миграции

### Entities
- Entities живут в `data/local/entities/`
- Domain models — в `domain/models/`
- Всегда используй маппер между ними, не передавай Entity в UI

---

## 5. Правила работы с Git

### Коммиты
- Коммит после каждой логически завершённой единицы работы
- Формат: `тип: описание` (см. CODESTYLE.md)
- Не коммить нерабочий код
- Не коммить секреты, ключи, пароли

### Ветки
- Работай в feature-ветке
- Не пуш в main напрямую

---

## 6. Правила для UI (Compose)

### Composable-функции
- Preview для каждого значимого компонента
- `modifier` — всегда последний параметр
- Не делай heavy computation в Composable — используй `remember` / `derivedStateOf`
- Переиспользуй компоненты — складывай общие в `features/*/ui/components/`

### Тема
- Используй только цвета из `MaterialTheme.colorScheme`
- Не хардкодь цвета
- Используй типографику из `MaterialTheme.typography`

---

## 7. Правила для тестирования

### Обязательные тесты
- Unit-тесты для каждого UseCase
- Unit-тесты для ViewModel (state transitions)
- Unit-тесты для бизнес-логики (калькуляторы, генераторы, валидаторы)

### Опциональные тесты
- Integration-тесты для Repository + DAO
- UI-тесты для критических user flows

### Не тестируй
- Простые data classes
- Код, который просто делегирует вызов (pass-through)

---

## 8. Правила безопасности

- API ключи — только в `EncryptedSharedPreferences`
- Не логируй чувствительные данные
- Не храни пароли в plain text
- ProGuard rules для всех сетевых библиотек

---

## 9. Правила документации

### Что документировать
- Сложную бизнес-логику (алгоритмы адаптации, расчёты циклов сна)
- Архитектурные решения ("почему так, а не иначе")
- Workaround-ы для платформенных багов

### Что НЕ документировать
- Очевидный код (`fun getAlarms() = dao.getAll()`)
- Стандартные паттерны (Repository, ViewModel)

---

## 10. Порядок работы над итерацией

1. Прочитай `docs/iterations/<текущая>.md`
2. Создай структуру папок и `index.md`
3. Начни с domain-слоя (models, interfaces, use cases)
4. Реализуй data-слой (entities, DAO, repository impl)
5. Создай presentation (ViewModel, UI)
6. Напиши тесты
7. Обнови `index.md` во всех затронутых папках
8. Обнови статус итерации в `docs/iterations/`
9. Коммит и пуш
