# Iteration 3.2: Smart Alarm Window + Motion Detection + Smartwatch

**Итерация:** 3 (Циклы сна + Аналитика)
**Срок:** 8-12 дней
**Статус:** Не начата

## Цель

Умное пробуждение: будильник срабатывает в оптимальный момент внутри окна (например, 6:30-7:00), ориентируясь на движения пользователя.

## Задачи

### Smart Wake Window
- [ ] Toggle в настройках будильника: "Умное пробуждение"
- [ ] Настройка окна: 10 / 15 / 20 / 30 минут до будильника
- [ ] Логика: будильник может сработать в любой момент внутри окна
- [ ] Гарантированное пробуждение к концу окна

### Motion Detection (опционально)
- [ ] `MotionDetectionService` — Foreground Service
- [ ] Акселерометр для детекции движений во сне
- [ ] Алгоритм: движение = лёгкая фаза сна → будить
- [ ] Запуск сервиса за N минут до начала окна
- [ ] Battery-efficient: опрос каждые 5 секунд, не постоянно

### Fallback логика
- [ ] Если motion detection отключён → будить посередине окна
- [ ] Если нет движения за весь период → будить в конце окна
- [ ] Если motion detection не может запуститься → обычный будильник

### Настройки
- [ ] Settings: глобальный toggle motion tracking
- [ ] Per-alarm toggle: "Умное пробуждение"
- [ ] Battery optimization: запрос exemption при включении
- [ ] Notification: "Smart alarm отслеживает сон"

## Критерии завершения

- Smart window работает — будильник срабатывает внутри окна
- Motion detection опционален и отключаем
- Battery impact минимален
- Fallback логика надёжна

## Зависимости

- MVP 1.3 (AlarmScheduler, WakeLockService)
- IT-2.3 (расширенное логирование для записи smart wake данных)

### Smartwatch / Health Connect интеграция

- [ ] Интеграция с **Health Connect API** (Android):
  - Чтение данных сна (sleep sessions) с умных часов
  - Определение момента засыпания по HR/акселерометру часов
  - Автоматический расчёт оптимального пробуждения
- [ ] Логика: "лёг в 23:47 → оптимальное пробуждение 7:17"
- [ ] Пробуждение в фазе лёгкого сна по данным пульса (если доступны)
- [ ] Fallback: если данных с часов нет → motion detection через акселерометр телефона
- [ ] Settings: выбор источника данных (Health Connect / акселерометр / отключено)
- [ ] UI: отображение источника данных на экране будильника

## Критерии завершения

- Smart window работает — будильник срабатывает внутри окна
- Motion detection опционален и отключаем
- Health Connect интеграция работает (если часы есть) с graceful fallback
- Battery impact минимален
- Fallback логика надёжна

## Зависимости

- MVP 1.3 (AlarmScheduler, WakeLockService)
- MVP 1.6 (SleepCycleCalculator)
- IT-2.3 (расширенное логирование для записи smart wake данных)

## Риски

- Значительное потребление батареи при мониторинге сенсоров — оптимизировать частоту опроса
- Ложные срабатывания (телефон двигается на кровати) — настраиваемый threshold
- Health Connect доступен только на Android 14+ или через APK — нужен fallback
- Данные с часов могут запаздывать — учитывать latency
